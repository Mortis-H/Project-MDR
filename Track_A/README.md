## MDR: MLIR-to-AMDGPU Device Pipeline Demo

This project demonstrates a **device-only MLIR lowering pipeline** for AMD GPUs (ROCm), starting from a minimal MLIR GPU kernel and producing:

* **AMDGPU ISA**
* **HSA Code Object (HSACO)**
* **Human-readable LLVM IR** extracted from device bitcode

All steps are automated through the Python script **`mdr.py`**.

This guide explains how to:

1. Clone and build ROCm’s fork of LLVM/MLIR
2. Configure and compile with Ninja
3. Set up your environment (PATH)
4. Run `mdr.py` to reproduce the full pipeline

---

## 1. Clone ROCm’s LLVM Project

ROCm maintains its own LLVM fork, containing AMDGPU backend updates, MLIR ROCDL conversions, and ROCm device libraries.

Clone it from GitHub:

```bash
git clone https://github.com/rocm/llvm-project.git
cd llvm-project
git checkout amd-staging
```

**Important:**
Use the branch **`amd-staging`** — this branch contains the required ROCm device libraries and GPU lowering components.

---

## 2. Create a Build Directory

Use an out-of-tree build:

```bash
cd llvm-project
mkdir build
cd build
```

---

## 3. Configure LLVM/MLIR With CMake + Ninja

Use the following recommended configuration:

```bash
cmake -G Ninja ../llvm \
  -DLLVM_ENABLE_PROJECTS="clang;mlir;lld" \
  -DLLVM_TARGETS_TO_BUILD="AMDGPU;X86" \
  -DLLVM_ENABLE_ASSERTIONS=ON \
  -DMLIR_ENABLE_GPU=ON \
  -DMLIR_ENABLE_ROCM_CONVERSIONS=ON \
  -DMLIR_ENABLE_ROCM_RUNNER=ON \
  -DMLIR_INCLUDE_INTEGRATION_TESTS=ON \
  -DCMAKE_BUILD_TYPE=RelWithDebInfo
```

### Explanation of important flags

| CMake Flag                              | Purpose                                                |
| --------------------------------------- | ------------------------------------------------------ |
| `LLVM_ENABLE_PROJECTS="clang;mlir;lld"` | Build Clang, MLIR, and LLD (all required for `mdr.py`) |
| `LLVM_TARGETS_TO_BUILD="AMDGPU;X86"`    | Enable AMD GPU backend + x86 host backend              |
| `MLIR_ENABLE_GPU=ON`                    | Enable MLIR GPU dialect & transformations              |
| `MLIR_ENABLE_ROCM_CONVERSIONS=ON`       | Enable GPU→ROCDL lowering passes                       |
| `LLVM_ENABLE_ASSERTIONS=ON`             | Helpful for debugging                                  |
| `CMAKE_BUILD_TYPE=RelWithDebInfo`       | Optimized build with debug info                        |

---

## 4. Build LLVM/MLIR With Ninja

To build everything:

```bash
ninja
```

Or to build only the tools required by `mdr.py`:

```bash
ninja mlir-opt llvm-mc llvm-dis ld.lld
```

When finished, binaries will be located in:

```
llvm-project/build/bin
```

---

## 5. Add LLVM Tools to PATH

`mdr.py` requires tools such as `mlir-opt`, `llvm-mc`, `llvm-dis`, and `ld.lld`.

Set your PATH:

```bash
export PATH=/path/to/llvm-project/build/bin:$PATH
```

You may permanently add this to your shell configuration:

```bash
echo 'export PATH=/path/to/llvm-project/build/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

Verify:

```bash
which mlir-opt
which llvm-mc
which llvm-dis
which ld.lld
```

---

## 6. Running `mdr.py`

The script `mdr.py` performs:

1. **Part A – MLIR Generation**

   * Generates a minimal `gpu.module` containing a kernel with one `i32` argument
   * Uses `gpu.printf` to print the argument as a hexadecimal value

2. **Part B – Device-only Compilation Pipelines**

   * Runs MLIR lowering pipeline
     (`gpu-kernel-outlining → rocdl-attach-target → convert-gpu-to-rocdl → gpu-to-llvm → gpu-module-to-binary`)
   * Extracts:

     * **AMDGPU ISA** (`format=isa`)
     * **LLVM bitcode**, decodes it, and runs `llvm-dis` to obtain **LLVM IR** (`format=llvm`)
   * Produces:

     * `kernel.hsaco`
     * `kernel_isa.s`
     * `kernel_llvm.ll`

Run the script:

```bash
python3 mdr.py --chip gfx950 --workdir out
```

### Optional flags

| Flag             | Meaning                                                       |
| ---------------- | ------------------------------------------------------------- |
| `--emit-llvm-ir` | Also generate LLVM IR via `gpu-module-to-binary{format=llvm}` |
| `--no-emit-isa`  | Disable ISA + HSACO generation                                |
| `--chip <gfx>`   | Select target GPU architecture (default: `gfx950`)            |

Example: generate everything:

```bash
python3 mdr.py --chip gfx950 --workdir out --emit-llvm-ir
```

Example: only LLVM IR:

```bash
python3 mdr.py --workdir out_llvm --no-emit-isa --emit-llvm-ir
```

---

## 7. Output Files

After running, the output directory contains:

| File                      | Description                                  |
| ------------------------- | -------------------------------------------- |
| `kernel.mlir`             | Original MLIR module generated by Part A     |
| `kernel_binary_isa.mlir`  | MLIR after lowering / ISA embedding          |
| `kernel_isa.s`            | Extracted AMDGPU ISA                         |
| `kernel.o`                | Object file assembled from ISA               |
| `kernel.hsaco`            | Final HSA code object                        |
| `kernel_binary_llvm.mlir` | MLIR after lowering / LLVM bitcode embedding |
| `kernel_llvm.bc`          | Extracted raw bitcode from gpu.binary        |
| `kernel_llvm.ll`          | Human-readable LLVM IR (`llvm-dis` output)   |

---

## 8. Troubleshooting

**`mlir-opt: command not found`**
→ Ensure your PATH includes `llvm-project/build/bin`.

**`No gpu.binary assembly attribute found`**
→ MLIR pass pipeline may not be recognized; verify pass names:

```bash
mlir-opt --pass-pipeline-help | grep -i gpu
```

**`llvm-mc: unsupported triple`**
→ Ensure AMDGPU backend was built (`LLVM_TARGETS_TO_BUILD=AMDGPU`).

---

## 9. License

This project uses ROCm’s LLVM fork and follows its licensing (Apache 2.0 + LLVM exceptions).
Your own `mdr.py` script may be licensed independently.
